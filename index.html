<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å­¸ç”Ÿéš¨æ©Ÿåˆ†çµ„ç³»çµ±</title>

<style>
body {
  font-family: "Microsoft JhengHei", Arial;
  background: #f2f5f9;
  padding: 20px;
}
h1 { text-align: center; }
textarea, input {
  width: 100%;
  padding: 12px;
  font-size: 18px;
  margin: 6px 0;
}
button {
  padding: 14px 20px;
  font-size: 18px;
  margin: 5px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}
button:hover { opacity: 0.9; }
.btn {
  background: #2563eb;
  color: white;
}
.group {
  background: white;
  padding: 15px;
  margin: 10px 0;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  font-size: 20px;
}
</style>
</head>

<body>

<h1>ğŸ’ å­¸ç”Ÿéš¨æ©Ÿåˆ†çµ„ç³»çµ±</h1>

<label>å­¸ç”Ÿåå–®ï¼ˆæ¯è¡Œä¸€äººï¼‰</label>
<textarea id="students" rows="8" placeholder="ç‹å°æ˜
æå°è¯
é™³åŒå­¸"></textarea>

<label>ä¸èƒ½åŒçµ„å­¸ç”Ÿï¼ˆæ¯è¡Œä¸€çµ„ï¼Œç”¨é€—è™Ÿï¼‰</label>
<textarea id="restrictions" rows="4" placeholder="ç‹å°æ˜,æå°è¯"></textarea>

<label>æ¯çµ„äººæ•¸</label>
<input type="number" id="groupSize" value="3" min="2">

<button class="btn" onclick="generateGroups()">ğŸ² éš¨æ©Ÿåˆ†çµ„</button>
<button class="btn" onclick="exportPDF()">ğŸ“„ åŒ¯å‡º PDF</button>
<button class="btn" onclick="exportCSV()">ğŸ“Š åŒ¯å‡º Excel</button>

<h2>ğŸ“Œ åˆ†çµ„çµæœ</h2>
<div id="result"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
let currentGroups = [];

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function generateGroups() {
  const students = document.getElementById('students').value
    .split('\n').map(s => s.trim()).filter(Boolean);

  const rules = document.getElementById('restrictions').value
    .split('\n').map(r => r.split(',').map(s => s.trim()));

  const size = parseInt(document.getElementById('groupSize').value);
  let attempts = 0;

  while (attempts < 1000) {
    let temp = [...students];
    shuffle(temp);
    let groups = [];

    for (let i = 0; i < temp.length; i += size) {
      groups.push(temp.slice(i, i + size));
    }

    let ok = true;
    for (let [a, b] of rules) {
      for (let g of groups) {
        if (g.includes(a) && g.includes(b)) ok = false;
      }
    }

    if (ok) {
      currentGroups = groups;
      render(groups);
      return;
    }
    attempts++;
  }
  alert("âš ï¸ ç„¡æ³•ç¬¦åˆé™åˆ¶æ¢ä»¶ï¼Œè«‹èª¿æ•´åå–®æˆ–é™åˆ¶");
}

function render(groups) {
  const result = document.getElementById('result');
  result.innerHTML = '';
  groups.forEach((g, i) => {
    const div = document.createElement('div');
    div.className = 'group';
    div.innerHTML = `<b>ç¬¬ ${i+1} çµ„ï¼š</b> ${g.join('ã€')}`;
    result.appendChild(div);
  });
}

function exportPDF() {
  html2canvas(document.getElementById('result')).then(canvas => {
    const img = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF();
    const w = pdf.internal.pageSize.getWidth();
    const h = canvas.height * w / canvas.width;
    pdf.addImage(img, 'PNG', 0, 0, w, h);
    pdf.save('åˆ†çµ„çµæœ.pdf');
  });
}

function exportCSV() {
  if (!currentGroups.length) return alert("è«‹å…ˆåˆ†çµ„");

  let csv = "çµ„åˆ¥,å­¸ç”Ÿ\n";
  currentGroups.forEach((g, i) => {
    g.forEach(name => {
      csv += `ç¬¬${i+1}çµ„,${name}\n`;
    });
  });

  const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "åˆ†çµ„çµæœ.csv";
  link.click();
}
</script>

</body>
</html>
