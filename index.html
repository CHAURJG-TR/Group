<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>åˆ†çµ„åº§ä½ç³»çµ±ï¼ˆæœ€çµ‚ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:"Microsoft JhengHei",Arial;
  background:#f1f5f9;
  padding:20px;
}
h1{text-align:center}

textarea,button{
  width:100%;
  font-size:18px;
  padding:12px;
  margin:6px 0;
}

button{
  border:none;
  border-radius:12px;
  background:#2563eb;
  color:#fff;
  cursor:pointer;
}

#groups{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:24px;
  margin-top:20px;
}

.group{
  background:#e5e7eb;
  padding:14px;
  border-radius:16px;
  box-shadow:0 4px 10px rgba(0,0,0,.15);
}

.group h2{text-align:center}

.face{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px 40px;
  justify-items:center;
  margin-bottom:10px;
}

.seat,.back{
  background:#fff;
  width:110px;
  height:60px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
}

.back{
  background:#fde68a;
  margin:0 auto;
}

.seat[draggable="true"]{cursor:grab}

.fullscreen textarea,
.fullscreen button{display:none}

.fullscreen .seat,
.fullscreen .back{
  font-size:32px;
  height:100px;
}
</style>
</head>

<body>

<h1>ğŸ² åˆ†çµ„åº§ä½ï¼ˆ4 çµ„ï½œé¢å°é¢ï¼‰</h1>

<textarea id="students" rows="6" placeholder="å­¸ç”Ÿåå–®ï¼ˆ20 äººï¼Œæ¯è¡Œä¸€äººï¼‰"></textarea>

<textarea id="ban" rows="3"
placeholder="ä¸èƒ½åŒä¸€çµ„ï¼ˆæ¯è¡Œä¸€æ¢ï¼Œç”¨ , åˆ†éš”ï¼‰"></textarea>

<textarea id="fixedBack" rows="2"
placeholder="å›ºå®šåå¾Œé¢ï¼ˆæ¯è¡Œä¸€äººï¼Œä¾‹å¦‚çµ„é•·ï¼‰"></textarea>

<button onclick="makeGroups()">ğŸ¯ éš¨æ©Ÿåˆ†çµ„</button>
<button onclick="exportPDF()">ğŸ–¨ï¸ åŒ¯å‡º PDF</button>
<button onclick="toggleFull()">ğŸ–¥ï¸ æŠ•å½±æ¨¡å¼</button>

<div id="groups"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const studentsEl = document.getElementById("students");
const banEl = document.getElementById("ban");
const fixedEl = document.getElementById("fixedBack");

studentsEl.value = localStorage.students || "";
banEl.value = localStorage.ban || "";
fixedEl.value = localStorage.fixed || "";

studentsEl.oninput = ()=>localStorage.students = studentsEl.value;
banEl.oninput = ()=>localStorage.ban = banEl.value;
fixedEl.oninput = ()=>localStorage.fixed = fixedEl.value;

let groupsData = [];

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}

function parseLines(el){
  return el.value.split('\n').map(s=>s.trim()).filter(Boolean);
}

function validGroup(g,bans){
  return !bans.some(r => r.every(n => g.includes(n)));
}

function makeGroups(){
  let students = parseLines(studentsEl);
  if(students.length !== 20){
    alert("âš ï¸ å›ºå®š 20 äººï¼ˆ4 çµ„ï¼‰");
    return;
  }

  const bans = banEl.value.split('\n')
    .map(l=>l.split(',').map(s=>s.trim()).filter(Boolean))
    .filter(r=>r.length>=2);

  const fixed = parseLines(fixedEl);

  for(let t=0;t<800;t++){
    shuffle(students);
    let tmp=[...students], ok=true, res=[];

    for(let i=0;i<4;i++){
      let g=tmp.splice(0,5);
      if(!validGroup(g,bans)) {ok=false;break;}

      const fb = g.filter(n=>fixed.includes(n));
      if(fb.length>1){ok=false;break;}

      if(fb.length===1){
        g = g.filter(n=>n!==fb[0]);
        g.push(fb[0]); // å›ºå®šå¾Œé¢
      }
      res.push(g);
    }

    if(ok){
      groupsData=res;
      render();
      return;
    }
  }
  alert("âŒ è¦å‰‡è¡çªï¼Œè«‹èª¿æ•´è¨­å®š");
}

function render(){
  const box=document.getElementById("groups");
  box.innerHTML="";

  groupsData.forEach((g,gi)=>{
    const div=document.createElement("div");
    div.className="group";
    div.innerHTML=`
      <h2>ç¬¬ ${gi+1} çµ„</h2>
      <div class="face">
        ${g.slice(0,4).map((n,i)=>`
          <div class="seat" draggable="true"
           ondragstart="drag(event,${gi},${i})"
           ondragover="event.preventDefault()"
           ondrop="drop(event,${gi},${i})">${n}</div>`).join("")}
      </div>
      <div class="back">${g[4]}</div>
    `;
    box.appendChild(div);
  });
}

let dragInfo=null;
function drag(e,g,i){ dragInfo={g,i}; }
function drop(e,g,i){
  if(!dragInfo || dragInfo.g!==g) return;
  [groupsData[g][dragInfo.i],groupsData[g][i]]=
  [groupsData[g][i],groupsData[g][dragInfo.i]];
  render();
}

function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF();
  let y=20;

  groupsData.forEach((g,i)=>{
    pdf.setFontSize(14);
    pdf.text(`ç¬¬ ${i+1} çµ„`,10,y); y+=8;
    g.forEach(n=>{ pdf.text("â€¢ "+n,14,y); y+=7; });
    y+=5;
  });

  pdf.save("åˆ†çµ„åº§ä½è¡¨.pdf");
}

function toggleFull(){
  document.body.classList.toggle("fullscreen");
  document.documentElement.requestFullscreen?.();
}
</script>

</body>
</html>
