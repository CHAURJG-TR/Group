<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>èª²å ‚åˆ†çµ„ç³»çµ±ï½œé˜²å‘†å®Œæ•´ç‰ˆ</title>

<style>
body{font-family:"Microsoft JhengHei",Arial;background:#eef2f7;padding:20px}
h1{text-align:center}
textarea,input{width:100%;font-size:18px;padding:10px;margin:6px 0}
button{font-size:18px;padding:12px 18px;margin:5px;border:none;border-radius:10px;cursor:pointer}
.primary{background:#2563eb;color:#fff}
.gray{background:#6b7280;color:#fff}
.warn{background:#dc2626;color:#fff}
.group{background:#fff;margin:12px 0;padding:16px;border-radius:14px;
font-size:28px;box-shadow:0 4px 10px rgba(0,0,0,.15);animation:pop .4s}
.member{display:inline-block;padding:6px 14px;margin:6px;background:#e0e7ff;
border-radius:10px;cursor:grab}
.draw{font-size:120px;text-align:center;margin:20px}
.fullscreen textarea,.fullscreen input,.fullscreen .controls{display:none}
.fullscreen .group{font-size:48px}
@keyframes pop{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
</style>
</head>

<body>

<h1>ğŸ“ èª²å ‚åˆ†çµ„ç³»çµ±ï¼ˆé˜²å‘†å®Œæ•´ç‰ˆï¼‰</h1>

<div class="controls">
<textarea id="students" rows="6" placeholder="å­¸ç”Ÿåå–®ï¼ˆæ¯è¡Œä¸€äººï¼‰"></textarea>
<input id="size" type="number" value="3" min="2">
<button class="primary" onclick="safeGroup(makeGroup)">ğŸ² éš¨æ©Ÿåˆ†çµ„</button>
<button class="primary" onclick="safeDraw(drawStudent)">ğŸ¯ æŠ½å­¸ç”Ÿ</button>
<button class="gray" onclick="toggleFull()">ğŸ–¥ï¸ æŠ•å½±æ¨¡å¼</button>
<button class="gray" onclick="safeExport(exportPDF)">ğŸ“„ PDF</button>
<button class="gray" onclick="safeExport(exportCSV)">ğŸ“Š Excel</button>
<button class="warn" onclick="resetAll()">ğŸ”„ é‡ç½®</button>
</div>

<div id="draw" class="draw"></div>
<div id="result"></div>

<audio id="beep" src="sounds/beep.mp3"></audio>
<audio id="drawSound" src="sounds/draw.mp3"></audio>
<audio id="okSound" src="sounds/success.mp3"></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
let groups=[], drawn=[], busy=false;
const studentsEl=document.getElementById("students");
studentsEl.value=localStorage.students||"";
studentsEl.oninput=()=>localStorage.students=studentsEl.value;

function vibrate(ms){navigator.vibrate&&navigator.vibrate(ms);}
function shuffle(a){for(let i=a.length-1;i>0;i--){let j=Math.random()*(i+1)|0;[a[i],a[j]]=[a[j],a[i]]}}

function cleanStudents(){
  return [...new Set(studentsEl.value.split('\n').map(s=>s.trim()).filter(Boolean))];
}

function lock(v){
  busy=v;
  document.querySelectorAll("button").forEach(b=>{b.disabled=v;b.style.opacity=v?.5:1});
}

function safeGroup(fn){
  if(busy) return;
  const s=cleanStudents();
  if(s.length<2) return alert("è‡³å°‘ 2 ä½å­¸ç”Ÿ");
  lock(true); fn(s,Math.max(2,+size.value||2)); lock(false);
}

function makeGroup(students,size){
  shuffle(students); groups=[];
  for(let i=0;i<students.length;i+=size) groups.push(students.slice(i,i+size));
  document.getElementById("okSound").play();
  render();
}

function render(){
  const r=document.getElementById("result"); r.innerHTML="";
  groups.forEach((g,i)=>{
    const d=document.createElement("div"); d.className="group";
    d.innerHTML=`ç¬¬ ${i+1} çµ„ï¼š`;
    g.forEach(m=>{
      const s=document.createElement("span");
      s.className="member"; s.textContent=m; s.draggable=true;
      s.ondragstart=e=>e.dataTransfer.setData("t",m);
      s.ondragover=e=>e.preventDefault();
      s.ondrop=e=>{swap(m,e.dataTransfer.getData("t"))};
      d.appendChild(s);
    });
    r.appendChild(d);
  });
}

function swap(a,b){
  if(a===b) return;
  groups.forEach(g=>{
    if(g.includes(a)) g[g.indexOf(a)]=b;
    else if(g.includes(b)) g[g.indexOf(b)]=a;
  });
  render();
}

async function safeDraw(fn){
  if(busy) return;
  const s=cleanStudents().filter(x=>!drawn.includes(x));
  if(!s.length) return alert("å·²å…¨éƒ¨æŠ½å®Œ");
  lock(true); await fn(s); lock(false);
}

async function drawStudent(pool){
  const d=document.getElementById("draw");
  for(let i=3;i>0;i--){
    d.textContent=i; beep.play(); vibrate(80);
    await new Promise(r=>setTimeout(r,1000));
  }
  const r=pool[Math.random()*pool.length|0];
  drawn.push(r);
  drawSound.play(); vibrate([200,100,200]);
  d.textContent="ğŸ¯ "+r;
}

function toggleFull(){
  document.body.classList.toggle("fullscreen");
  document.documentElement.requestFullscreen?.();
}

function safeExport(fn){
  if(!groups.length) return alert("å°šæœªåˆ†çµ„");
  fn();
}

function exportCSV(){
  let csv="çµ„åˆ¥,å­¸ç”Ÿ\n";
  groups.forEach((g,i)=>g.forEach(s=>csv+=`ç¬¬${i+1}çµ„,${s}\n`));
  const b=new Blob(["\ufeff"+csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b); a.download="åˆ†çµ„çµæœ.csv"; a.click();
}

function exportPDF(){
  html2canvas(result).then(c=>{
    const pdf=new jspdf.jsPDF();
    const w=pdf.internal.pageSize.getWidth();
    pdf.addImage(c.toDataURL(),"PNG",0,0,w,c.height*w/c.width);
    pdf.save("åˆ†çµ„çµæœ.pdf");
  });
}

function resetAll(){
  if(!confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) return;
  groups=[]; drawn=[];
  result.innerHTML=""; draw.textContent="";
}
</script>

</body>
</html>
