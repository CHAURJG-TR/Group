<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>åˆ†çµ„åº§ä½ç³»çµ±ï¼ˆè€å¸«ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:"Microsoft JhengHei",Arial;background:#f1f5f9;padding:20px;}
h1{text-align:center}
textarea,button{width:100%;font-size:18px;padding:12px;margin:6px 0;}
button{border:none;border-radius:12px;background:#2563eb;color:#fff;cursor:pointer;}
button:disabled{opacity:.5;}
#groups{display:grid;grid-template-columns:repeat(2,1fr);gap:24px;margin-top:20px;}
.group{background:#e5e7eb;padding:14px;border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.15);}
.group h2{text-align:center;}
.face{display:grid;grid-template-columns:1fr 1fr;gap:18px 40px;justify-items:center;margin-bottom:10px;}
.seat,.back{background:#fff;width:110px;height:60px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.back{background:#fde68a;margin:10px auto 0;}
#draw{position:fixed;inset:0;background:#020617;color:#fff;font-size:80px;display:none;align-items:center;justify-content:center;z-index:999;}
.flash{animation:flash .2s alternate 6}
@keyframes flash{from{background:#020617} to{background:#2563eb}}
.fullscreen textarea,.fullscreen button{display:none;}
.fullscreen .seat,.fullscreen .back{font-size:32px;height:100px;}
</style>
</head>
<body>

<h1>ğŸ¯ åˆ†çµ„åº§ä½ç³»çµ±ï¼ˆè€å¸«ç‰ˆï¼‰</h1>

<textarea id="students" rows="6" placeholder="å­¸ç”Ÿåå–®ï¼ˆ20 äººï¼Œæ¯è¡Œä¸€äººï¼‰"></textarea>
<textarea id="ban" rows="3" placeholder="ä¸èƒ½åŒä¸€çµ„ï¼Œæ¯è¡Œä¸€æ¢ï¼Œç”¨ , åˆ†éš”"></textarea>
<textarea id="fixedBack" rows="2" placeholder="å›ºå®šåå¾Œé¢ï¼ˆçµ„é•·ï¼Œæ¯è¡Œä¸€äººï¼‰"></textarea>

<button onclick="drawAndGroup()">ğŸ¯ æŠ½ç±¤åˆ†çµ„ï¼ˆå‹•ç•«ï¼‰</button>
<button onclick="toggleFull()">ğŸ–¥ï¸ æŠ•å½±æ¨¡å¼</button>
<button onclick="exportPDF()">ğŸ–¨ï¸ åŒ¯å‡º PDF</button>

<div id="groups"></div>
<div id="draw"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const drawEl=document.getElementById("draw");
const studentsEl=document.getElementById("students");
const banEl=document.getElementById("ban");
const fixedEl=document.getElementById("fixedBack");
let groupsData=[];

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}

function parseLines(el){return el.value.split('\n').map(s=>s.trim()).filter(Boolean);}
function parseBans(){return banEl.value.split('\n').map(l=>l.split(',').map(s=>s.trim()).filter(Boolean)).filter(r=>r.length>=2);}

function validGroup(g,bans){return !bans.some(r=>r.every(n=>g.includes(n)));}

function drawAndGroup(){
  let list=parseLines(studentsEl);
  if(list.length<20){alert("âš ï¸ åå–®ä¸è¶³ 20 äºº"); return;}
  drawEl.style.display="flex";
  let t=30;
  const beep=new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=");
  const timer=setInterval(()=>{
    drawEl.textContent=list[Math.floor(Math.random()*list.length)];
    beep.play();
    t--;
    if(t<=0){
      clearInterval(timer);
      drawEl.classList.add("flash");
      setTimeout(()=>{drawEl.style.display="none";drawEl.classList.remove("flash");makeGroups(list);},800);
    }
  },100);
}

function makeGroups(students){
  const bans=parseBans();
  const fixed=parseLines(fixedEl);
  let attempt=0, success=false;

  while(attempt<800 && !success){
    attempt++;
    shuffle(students);
    let temp=[...students], ok=true, res=[];

    for(let i=0;i<4;i++){
      let g=temp.splice(0,5);
      if(!validGroup(g,bans)){ok=false;break;}
      const fb=g.filter(n=>fixed.includes(n));
      if(fb.length>1){ok=false;break;}
      if(fb.length===1){g=g.filter(n=>n!==fb[0]); g.push(fb[0]);}
      res.push(g);
    }
    if(ok){groupsData=res;success=true;break;}
  }
  if(!success){alert("âŒ è¦å‰‡è¡çªï¼Œç„¡æ³•å®Œæˆåˆ†çµ„"); return;}
  render();
}

function render(){
  const box=document.getElementById("groups");
  box.innerHTML="";
  groupsData.forEach((g,i)=>{
    const div=document.createElement("div");
    div.className="group";
    div.innerHTML=`
      <h2>ç¬¬ ${i+1} çµ„</h2>
      <div class="face">
        <div class="seat" draggable="true" ondragstart="drag(event,${i},0)" ondragover="event.preventDefault()" ondrop="drop(event,${i},0)">${g[0]}</div>
        <div class="seat" draggable="true" ondragstart="drag(event,${i},1)" ondragover="event.preventDefault()" ondrop="drop(event,${i},1)">${g[1]}</div>
        <div class="seat" draggable="true" ondragstart="drag(event,${i},2)" ondragover="event.preventDefault()" ondrop="drop(event,${i},2)">${g[2]}</div>
        <div class="seat" draggable="true" ondragstart="drag(event,${i},3)" ondragover="event.preventDefault()" ondrop="drop(event,${i},3)">${g[3]}</div>
      </div>
      <div class="back">${g[4]}</div>
    `;
    box.appendChild(div);
  });
}

/* æ‹–æ‹‰æ›ä½ï¼ˆçµ„å…§ï¼‰ */
let dragInfo=null;
function drag(e,g,i){dragInfo={g,i};}
function drop(e,g,i){if(!dragInfo||dragInfo.g!==g) return;[groupsData[g][dragInfo.i],groupsData[g][i]]=[groupsData[g][i],groupsData[g][dragInfo.i]];render();}

/* å…¨è¢å¹•æŠ•å½± */
function toggleFull(){document.body.classList.toggle("fullscreen");document.documentElement.requestFullscreen?.();}

/* PDF åŒ¯å‡º */
function exportPDF(){
  html2canvas(document.getElementById("groups")).then(canvas=>{
    const { jsPDF } = window.jspdf;
    const pdf=new jsPDF("p","mm","a4");
    const img=canvas.toDataURL("image/png");
    const w=190;
    const h=canvas.height*w/canvas.width;
    pdf.addImage(img,"PNG",10,10,w,h);
    pdf.save("åˆ†çµ„åº§ä½è¡¨.pdf");
  });
}
</script>

</body>
</html>
