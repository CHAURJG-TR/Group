<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>學生隨機分組系統</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f0f4f8; }
  h1 { text-align: center; }
  textarea, input { width: 100%; padding: 10px; margin: 5px 0; font-size: 16px; }
  button { padding: 10px 20px; font-size: 16px; margin: 5px; cursor: pointer; }
  .group { background: #fff; padding: 10px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<h1>學生隨機分組系統</h1>

<label>學生名單（每行一個學生）：</label>
<textarea id="students" rows="10" placeholder="輸入學生姓名"></textarea>

<label>禁止同組學生對（每行一對，用逗號分隔）：</label>
<textarea id="restrictions" rows="5" placeholder="例如：張三,李四"></textarea>

<label>每組人數：</label>
<input type="number" id="groupSize" value="3" min="2">

<button onclick="generateGroups()">生成分組</button>
<button onclick="exportPDF()">匯出 PDF</button>

<h2>分組結果：</h2>
<div id="result"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
function generateGroups() {
  const students = document.getElementById('students').value.split('\n').map(s => s.trim()).filter(Boolean);
  const restrictionsInput = document.getElementById('restrictions').value.split('\n').map(r => r.trim()).filter(Boolean);
  const restrictions = restrictionsInput.map(r => r.split(',').map(s => s.trim()));

  const groupSize = parseInt(document.getElementById('groupSize').value);
  let shuffled = [...students];

  // 隨機洗牌
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }

  let groups = [];
  let attempts = 0;
  const maxAttempts = 1000;

  while (attempts < maxAttempts) {
    groups = [];
    for (let i = 0; i < shuffled.length; i += groupSize) {
      groups.push(shuffled.slice(i, i + groupSize));
    }

    // 檢查限制
    let valid = true;
    for (const [a, b] of restrictions) {
      for (const group of groups) {
        if (group.includes(a) && group.includes(b)) {
          valid = false;
          break;
        }
      }
      if (!valid) break;
    }

    if (valid) break;
    // 重新洗牌
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    attempts++;
  }

  const resultDiv = document.getElementById('result');
  resultDiv.innerHTML = '';
  groups.forEach((group, index) => {
    const div = document.createElement('div');
    div.className = 'group';
    div.innerHTML = `<strong>第 ${index + 1} 組：</strong> ${group.join(', ')}`;
    resultDiv.appendChild(div);
  });

  if (attempts === maxAttempts) {
    alert('無法滿足限制條件，請調整學生或限制');
  }
}

function exportPDF() {
  const resultDiv = document.getElementById('result');
  html2canvas(resultDiv).then(canvas => {
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF();
    const imgProps = pdf.getImageProperties(imgData);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save('分組結果.pdf');
  });
}
</script>

</body>
</html>
