<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>èª²å ‚åˆ†çµ„ç³»çµ± PRO+</title>

<script>
let drawn = [];
let locking = false;

const beep = new Audio("sounds/beep.mp3");
const drawSound = new Audio("sounds/draw.mp3");

function vibrate(ms){
  if (navigator.vibrate) navigator.vibrate(ms);
}

function getStudents(){
  return document.getElementById('students')
    .value.split('\n').map(s=>s.trim()).filter(Boolean);
}

async function drawOne(){
  if(locking) return;                     // é˜²é€£é»
  const students = getStudents();
  if(!students.length){
    alert("â—è«‹å…ˆè¼¸å…¥å­¸ç”Ÿåå–®");
    return;
  }
  if(drawn.length >= students.length){
    alert("âœ… å…¨éƒ¨éƒ½æŠ½å®Œäº†");
    return;
  }

  locking = true;
  disableButtons(true);

  const drawDiv = document.getElementById('draw');
  drawDiv.style.fontSize = "120px";
  drawDiv.style.textAlign = "center";

  // 3-2-1 å€’æ•¸
  for(let i=3;i>=1;i--){
    drawDiv.textContent = i;
    beep.currentTime = 0;
    beep.play();
    vibrate(80);
    await sleep(1000);
  }

  // æŠ½äººï¼ˆæ’é™¤å·²æŠ½ï¼‰
  const pool = students.filter(s=>!drawn.includes(s));
  const result = pool[Math.floor(Math.random()*pool.length)];
  drawn.push(result);

  drawSound.play();
  vibrate([200,100,200]);

  drawDiv.style.fontSize = "64px";
  drawDiv.textContent = "ğŸ¯ æŠ½åˆ°ï¼š" + result;

  showDrawnList();
  disableButtons(false);
  locking = false;
}

function showDrawnList(){
  let list = document.getElementById("drawnList");
  if(!list){
    list = document.createElement("div");
    list.id = "drawnList";
    list.style.marginTop = "20px";
    document.body.appendChild(list);
  }
  list.innerHTML = "ğŸ“Œ å·²æŠ½ï¼š " + drawn.join("ã€");
}

function disableButtons(disable){
  document.querySelectorAll("button").forEach(b=>{
    if(b.textContent.includes("æŠ½")){
      b.disabled = disable;
      b.style.opacity = disable ? .5 : 1;
    }
  });
}

function sleep(ms){
  return new Promise(r=>setTimeout(r,ms));
}
</script>

</head>

<body>

<h1>ğŸ“ èª²å ‚åˆ†çµ„ç³»çµ± PRO+</h1>

<textarea id="students" rows="6" placeholder="å­¸ç”Ÿåå–®ï¼ˆæ¯è¡Œä¸€äººï¼‰"></textarea>
<input id="size" type="number" value="3">

<button class="primary" onclick="makeGroup()">ğŸ² éš¨æ©Ÿåˆ†çµ„</button>
<button class="primary" onclick="drawOne()">ğŸ¯ æŠ½å­¸ç”Ÿ</button>
<button class="gray" onclick="exportCSV()">ğŸ“Š åŒ¯å‡º Excel</button>
<button class="gray" onclick="exportPDF()">ğŸ“„ åŒ¯å‡º PDF</button>

<div id="draw"></div>
<div id="result"></div>

<audio id="drawSound" src="sounds/draw.mp3"></audio>
<audio id="okSound" src="sounds/success.mp3"></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
let groups=[];
const drawSound=document.getElementById('drawSound');
const okSound=document.getElementById('okSound');

document.getElementById('students').value =
  localStorage.students||"";

document.getElementById('students').oninput=e=>
  localStorage.students=e.target.value;

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}

function makeGroup(){
  const students=document.getElementById('students').value
    .split('\n').filter(x=>x);
  const size=+document.getElementById('size').value;
  shuffle(students);
  groups=[];
  for(let i=0;i<students.length;i+=size)
    groups.push(students.slice(i,i+size));
  okSound.play();
  render();
}

function render(){
  const r=document.getElementById('result');
  r.innerHTML='';
  groups.forEach((g,i)=>{
    const d=document.createElement('div');
    d.className='group';
    d.innerHTML=`ç¬¬ ${i+1} çµ„ï¼š${g.join('ã€')}`;
    r.appendChild(d);
  });
}

function drawOne(){
  const students=document.getElementById('students').value
    .split('\n').filter(x=>x);
  if(!students.length) return;
  drawSound.play();
  const s=students[Math.floor(Math.random()*students.length)];
  const d=document.getElementById('draw');
  d.className='draw';
  d.textContent="ğŸ¯ æŠ½åˆ°ï¼š"+s;
}

function exportCSV(){
  let csv="çµ„åˆ¥,å­¸ç”Ÿ\n";
  groups.forEach((g,i)=>{
    g.forEach(s=>csv+=`ç¬¬${i+1}çµ„,${s}\n`);
  });
  const blob=new Blob(["\ufeff"+csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download="åˆ†çµ„çµæœ.csv";
  a.click();
}

function exportPDF(){
  html2canvas(document.getElementById('result')).then(c=>{
    const pdf=new jspdf.jsPDF();
    const w=pdf.internal.pageSize.getWidth();
    const h=c.height*w/c.width;
    pdf.addImage(c.toDataURL(),'PNG',0,0,w,h);
    pdf.save("åˆ†çµ„çµæœ.pdf");
  });
}
</script>

</body>
</html>
