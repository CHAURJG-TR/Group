  <!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>åˆ†çµ„åº§ä½ç³»çµ±ï¼ˆç”·å¥³åˆ†çµ„ï¼‹è¬›å°ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:"Microsoft JhengHei",Arial;background:#f1f5f9;padding:20px;}
h1{text-align:center;margin-bottom:10px;}
textarea,button{width:100%;font-size:18px;padding:12px;margin:6px 0;}
button{border:none;border-radius:12px;background:#2563eb;color:#fff;cursor:pointer;}
button:disabled{opacity:.5;}
#groups{display:grid;grid-template-columns:repeat(2,1fr);gap:24px;margin-top:20px;}
.group{background:#e5e7eb;padding:14px;border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.15);}
.group h2{text-align:center;margin-bottom:8px;}
.face{display:grid;grid-template-columns:1fr 1fr;gap:18px 40px;justify-items:center;margin-bottom:10px;}
.seat,.back{background:#fff;width:110px;height:60px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.back{background:#fde68a;margin:10px auto 0;}
#podium{background:#f87171;color:#fff;font-weight:bold;text-align:center;padding:8px;border-radius:12px;margin-bottom:12px;width:100px;margin-left:auto;margin-right:auto;}
.fullscreen textarea,.fullscreen button{display:none;}
.fullscreen .seat,.fullscreen .back{font-size:32px;height:100px;}
</style>
</head>
<body>

<h1>åˆ†çµ„åº§ä½ç³»çµ±ï¼ˆç”·å¥³åˆ†çµ„ï¼‹è¬›å°ï¼‰</h1>

<div id="podium">è¬›å°</div>

<textarea id="male" rows="6" placeholder="ç”·ç”Ÿåå–®ï¼ˆ10 äººï¼Œæ¯è¡Œä¸€äººï¼‰"></textarea>
<textarea id="female" rows="6" placeholder="å¥³ç”Ÿåå–®ï¼ˆ10 äººï¼Œæ¯è¡Œä¸€äººï¼‰"></textarea>
<textarea id="ban" rows="3" placeholder="ä¸èƒ½åŒä¸€çµ„ï¼Œæ¯è¡Œä¸€æ¢ï¼Œç”¨ , åˆ†éš”"></textarea>

<button onclick="makeGroups()">ç”Ÿæˆåˆ†çµ„</button>
<button onclick="toggleFull()">ğŸ–¥ï¸ æŠ•å½±æ¨¡å¼</button>
<button onclick="switchColumn()">ğŸ“Š ç›´æ’æ¨¡å¼</button>
<button onclick="exportPDF()">ğŸ–¨ï¸ åŒ¯å‡º PDF</button>
<button onclick="resetAll()">ğŸ”„ é‡è¨­</button>

<div id="groups"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const maleEl = document.getElementById("male");
const femaleEl = document.getElementById("female");
const banEl = document.getElementById("ban");
let groupsData=[];
let columnMode=false; // ç›´æ’æ¨¡å¼é–‹é—œ

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}

function parseLines(el){return el.value.split('\n').map(s=>s.trim()).filter(Boolean);}
function parseBans(){return banEl.value.split('\n').map(l=>l.split(',').map(s=>s.trim()).filter(Boolean)).filter(r=>r.length>=2);}
function validGroup(g,bans){return !bans.some(r=>r.every(n=>g.includes(n)));}

// ç”Ÿæˆåˆ†çµ„
function makeGroups(){
  const male=parseLines(maleEl);
  const female=parseLines(femaleEl);
  if(male.length!==10 || female.length!==10){alert("âš ï¸ ç”·ç”Ÿ/å¥³ç”Ÿå„éœ€ 10 äºº"); return;}
  const bans=parseBans();
  
  let attempt=0, success=false;
  while(attempt<800 && !success){
    attempt++;
    shuffle(male); shuffle(female);
    let tempMale=[...male], tempFemale=[...female], res=[];
    let ok=true;
    for(let i=0;i<4;i++){
      let g=i<2 ? tempMale.splice(0,5) : tempFemale.splice(0,5);
      if(!validGroup(g,bans)){ok=false;break;}
      res.push(g);
    }
    if(ok){groupsData=res;success=true;break;}
  }
  if(!success){alert("âŒ è¦å‰‡è¡çªï¼Œç„¡æ³•å®Œæˆåˆ†çµ„"); return;}
  render();
}

// æ¸²æŸ“åº§ä½
function render(){
  const box=document.getElementById("groups");
  box.innerHTML="";
  if(columnMode){
    // ç›´æ’æ¨¡å¼ 4 æ’ Ã— 5 äºº
    const allStudents = groupsData.flat();
    for(let r=0;r<4;r++){
      const rowDiv=document.createElement("div");
      rowDiv.className="group";
      rowDiv.innerHTML=`<h2>ç¬¬ ${r+1} æ’</h2>`;
      const faceDiv=document.createElement("div");
      faceDiv.className="face";
      faceDiv.style.gridTemplateColumns="repeat(5,1fr)";
      for(let c=0;c<5;c++){
        const idx=r*5+c;
        if(allStudents[idx]){
          const seat=document.createElement("div");
          seat.className="seat";
          seat.textContent=allStudents[idx];
          const gIndex = Math.floor(idx/5);
          const sIndex = idx%5;
          seat.setAttribute("draggable","true");
          seat.setAttribute("ondragstart",`drag(event,${gIndex},${sIndex})`);
          seat.setAttribute("ondragover","event.preventDefault()");
          seat.setAttribute("ondrop",`drop(event,${gIndex},${sIndex})`);
          faceDiv.appendChild(seat);
        }
      }
      rowDiv.appendChild(faceDiv);
      box.appendChild(rowDiv);
    }
  } else {
    // æ•™å®¤æ¨¡å¼
    groupsData.forEach((g,i)=>{
      const div=document.createElement("div");
      div.className="group";
      div.innerHTML=`
        <h2>ç¬¬ ${i+1} çµ„</h2>
        <div class="face">
          <div class="seat" draggable="true" ondragstart="drag(event,${i},0)" ondragover="event.preventDefault()" ondrop="drop(event,${i},0)">${g[0]}</div>
          <div class="seat" draggable="true" ondragstart="drag(event,${i},1)" ondragover="event.preventDefault()" ondrop="drop(event,${i},1)">${g[1]}</div>
          <div class="seat" draggable="true" ondragstart="drag(event,${i},2)" ondragover="event.preventDefault()" ondrop="drop(event,${i},2)">${g[2]}</div>
          <div class="seat" draggable="true" ondragstart="drag(event,${i},3)" ondragover="event.preventDefault()" ondrop="drop(event,${i},3)">${g[3]}</div>
        </div>
        <div class="back">${g[4]}</div>
      `;
      box.appendChild(div);
    });
  }
}

// çµ„å…§æ‹–æ‹‰
let dragInfo=null;
function drag(e,g,i){dragInfo={g,i};}
function drop(e,g,i){if(!dragInfo||dragInfo.g!==g) return;[groupsData[g][dragInfo.i],groupsData[g][i]]=[groupsData[g][i],groupsData[g][dragInfo.i]];render();}

// æŠ•å½±æ¨¡å¼ï¼ˆå¯é–‹/é›¢é–‹ï¼‰
function toggleFull(){
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen?.();
    document.body.classList.add("fullscreen");
  } else {
    document.exitFullscreen?.();
    document.body.classList.remove("fullscreen");
  }
}

// ç›´æ’æ¨¡å¼åˆ‡æ›
function switchColumn(){
  columnMode=!columnMode;
  render();
}

// PDF åŒ¯å‡º
function exportPDF(){
  const container=document.createElement("div");
  container.style.padding="10px";
  container.style.width="800px";

  const podium=document.createElement("div");
  podium.textContent="è¬›å°";
  podium.style.background="#f87171";
  podium.style.color="#fff";
  podium.style.fontWeight="bold";
  podium.style.textAlign="center";
  podium.style.padding="8px";
  podium.style.borderRadius="12px";
  podium.style.marginBottom="12px";
  podium.style.width="100%";
  container.appendChild(podium);

  const groupsClone=document.getElementById("groups").cloneNode(true);
  container.appendChild(groupsClone);

  document.body.appendChild(container);
  html2canvas(container).then(canvas=>{
    const { jsPDF } = window.jspdf;
    const pdf=new jsPDF("p","mm","a4");
    const img=canvas.toDataURL("image/png");
    const w=190;
    const h=canvas.height*w/canvas.width;
    pdf.addImage(img,"PNG",10,10,w,h);
    pdf.save("åˆ†çµ„åº§ä½è¡¨.pdf");
    document.body.removeChild(container);
  });
}

// é‡è¨­ + æ»¾å›åå–®
function resetAll(){
  if(confirm("ç¢ºå®šè¦é‡è¨­æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) {
    maleEl.value="";
    femaleEl.value="";
    banEl.value="";
    document.getElementById("groups").innerHTML="";
    groupsData=[];
    columnMode=false;
    maleEl.scrollIntoView({behavior:"smooth"});
    maleEl.focus();
  }
}
</script>

</body>
</html>

